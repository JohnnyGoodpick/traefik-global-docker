services:
  # --- 1. Security Gatekeeper (Socket Proxy) ---
  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: socket-proxy
    restart: always
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /run
      - /tmp
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Only permissions Traefik v3 needs to discover apps
      CONTAINERS: 1
      NETWORKS: 1
      SERVICES: 1
      INFO: 1
    networks:
      - socket-internal

  # --- 2. The Edge Router (Traefik v3) ---
  traefik:
    image: traefik:v3.6.7
    container_name: traefik
    restart: always
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Allows binding to 80/443 despite cap_drop
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "80:80"
      - "443:443/tcp"
      - "443:443/udp" # CRITICAL for FrankenPHP HTTP/3
    depends_on:
      - socket-proxy
    environment:
      - DOCKER_HOST=tcp://socket-proxy:2375
      - ACME_EMAIL=${ACME_EMAIL}
    tmpfs:
      - /tmp
    volumes:
      - ./acme.json:/acme.json:rw
      - ./logs:/var/log/traefik:rw
    networks:
      - app-proxy
      - socket-internal
    labels:
      - "traefik.enable=true"
      # Dashboard Router
      - "traefik.http.routers.dashboard.rule=Host(`${DASHBOARD_DOMAIN}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=myresolver"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth,security-headers"

      # Local testing (https://localhost/dashboard/ - accept browser warning)
      - "traefik.http.routers.dashboard-local.rule=Host(`localhost`)"
      - "traefik.http.routers.dashboard-local.entrypoints=websecure"
      - "traefik.http.routers.dashboard-local.tls=true"
      - "traefik.http.routers.dashboard-local.service=api@internal"
      - "traefik.http.routers.dashboard-local.middlewares=dashboard-auth"
      # Basic Auth (generate hash: docker run --rm httpd:2-alpine htpasswd -nB admin)
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${DASHBOARD_USER}:${DASHBOARD_PASSWORD_HASH}"

      # Security Headers (Applied globally via entrypoint)
      # Ref: https://doc.traefik.io/traefik/middlewares/http/headers/
      # Ref: https://owasp.org/www-project-secure-headers/
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"

      # No compression middleware because we handle it at app-level
      # Rate Limiting (Protects SaaS from brute force)
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      - "traefik.http.middlewares.rate-limit.ratelimit.period=1s"
      - "traefik.http.middlewares.rate-limit.ratelimit.sourceCriterion.ipStrategy.depth=1"

      # TLS Configuration (Enforcing TLS 1.2 minimum)
      - "traefik.tls.options.default.minVersion=VersionTLS12"

    command:
      # --- Dashboard & Health ---
      - "--ping=true"
      - "--api.dashboard=true"

      # --- Access Logs (Privacy & Performance Optimized) ---
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--accesslog.bufferingsize=100"
      - "--accesslog.fields.headers.defaultmode=drop"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.headers.names.X-Forwarded-For=keep"

      # Provider Configuration (via socket proxy for security)
      # Ref: https://doc.traefik.io/traefik/providers/docker/
      - "--providers.docker=true"
      - "--providers.docker.endpoint=tcp://socket-proxy:2375"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=app-proxy"

      # Entrypoints & HTTP/3
      - "--entrypoints.web.address=:80"

      # Automatic Global Redirect (HTTP -> HTTPS)
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http3" # Native HTTP/3 for FrankenPHP
      - "--entrypoints.websecure.http.middlewares=security-headers@docker,rate-limit@docker"

      # Real IP Propagation (Laravel octant/frankenphp requires this)
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=127.0.0.1/32,172.16.0.0/12,10.0.0.0/8"

      # Certificates (Let's Encrypt)
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"

      # SaaS Optimization: Prevent timeouts on long PHP requests
      - "--entrypoints.websecure.transport.respondingTimeouts.readTimeout=60s"
      - "--entrypoints.websecure.transport.respondingTimeouts.idleTimeout=180s"

networks:
  app-proxy:
    name: app-proxy
    external: false
  # Internal network for Docker socket proxy
  # Traefik <-> socket-proxy only, not exposed
  socket-internal:
    internal: true
